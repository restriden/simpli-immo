<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>simpli.immo Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #F3F4F6;
      min-height: 100vh;
    }

    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-card {
      background: white;
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .login-card h1 {
      font-size: 24px;
      color: #111827;
      margin-bottom: 8px;
    }

    .login-card p {
      color: #6B7280;
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #E5E7EB;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #F97316;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-primary {
      background: #F97316;
      color: white;
    }

    .btn-secondary {
      background: #F3F4F6;
      color: #374151;
    }

    .btn-danger {
      background: #FEE2E2;
      color: #EF4444;
    }

    .error-message {
      background: #FEE2E2;
      color: #EF4444;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    /* Dashboard Styles */
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    .login-container.hidden { display: none; }

    .header {
      background: white;
      padding: 16px 24px;
      border-bottom: 1px solid #E5E7EB;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 20px;
      color: #111827;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-info {
      font-size: 14px;
      color: #6B7280;
    }

    .logout-btn {
      padding: 8px 16px;
      background: #F3F4F6;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
    }

    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .tab {
      padding: 10px 20px;
      background: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      transition: all 0.2s;
    }

    .tab.active {
      background: #FFF7ED;
      color: #F97316;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-card .icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      font-size: 24px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
    }

    .stat-card .label {
      font-size: 14px;
      color: #6B7280;
      margin-top: 4px;
    }

    .card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid #F3F4F6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h2 {
      font-size: 16px;
      color: #111827;
    }

    .card-body {
      padding: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 14px 20px;
      text-align: left;
      border-bottom: 1px solid #F3F4F6;
    }

    th {
      font-size: 12px;
      font-weight: 600;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #F9FAFB;
    }

    td {
      font-size: 14px;
      color: #111827;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-success { background: #D1FAE5; color: #059669; }
    .badge-warning { background: #FEF3C7; color: #D97706; }
    .badge-danger { background: #FEE2E2; color: #EF4444; }

    .actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }

    .action-btn.toggle {
      background: #DBEAFE;
      color: #2563EB;
    }

    .action-btn.delete {
      background: #FEE2E2;
      color: #EF4444;
    }

    .empty-state {
      padding: 60px 20px;
      text-align: center;
      color: #6B7280;
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-overlay.hidden { display: none; }

    .modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #F3F4F6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 18px;
      color: #111827;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #6B7280;
      cursor: pointer;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid #F3F4F6;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-footer .btn {
      width: auto;
      padding: 12px 24px;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Analysis Styles */
    .analysis-config {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .analysis-config h3 {
      font-size: 18px;
      color: #111827;
      margin-bottom: 16px;
    }

    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .config-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .config-group label {
      font-size: 14px;
      font-weight: 500;
      color: #374151;
    }

    .config-group textarea,
    .config-group select,
    .config-group input {
      padding: 12px;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      font-size: 14px;
    }

    .config-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .config-group.full-width {
      grid-column: 1 / -1;
    }

    .analysis-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn-analyze {
      background: #8B5CF6;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-analyze:hover { opacity: 0.9; }
    .btn-analyze:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-export {
      background: #F3F4F6;
      color: #374151;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .analysis-status {
      font-size: 14px;
      color: #6B7280;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .result-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
    }

    .result-card .label {
      font-size: 12px;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .result-card .value {
      font-size: 28px;
      font-weight: 700;
      color: #111827;
    }

    .result-card .subvalue {
      font-size: 14px;
      color: #6B7280;
      margin-top: 4px;
    }

    .goals-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    .goal-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
    }

    .goal-card h3 {
      font-size: 16px;
      color: #111827;
      margin-bottom: 4px;
    }

    .goal-card .goal-name {
      font-size: 14px;
      color: #6B7280;
      margin-bottom: 16px;
    }

    .goal-stats {
      display: flex;
      gap: 24px;
      margin-bottom: 16px;
    }

    .goal-stat {
      text-align: center;
    }

    .goal-stat .number {
      font-size: 24px;
      font-weight: 700;
    }

    .goal-stat .label {
      font-size: 12px;
      color: #6B7280;
    }

    .goal-stat.achieved .number { color: #059669; }
    .goal-stat.blocked .number { color: #EF4444; }

    .blockers-list {
      background: #FEF2F2;
      border-radius: 8px;
      padding: 16px;
    }

    .blockers-list h4 {
      font-size: 13px;
      color: #EF4444;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .blocker-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(239, 68, 68, 0.1);
      font-size: 14px;
      color: #374151;
    }

    .blocker-item:last-child { border-bottom: none; }

    .blocker-count {
      background: #FEE2E2;
      color: #EF4444;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .faq-section {
      background: white;
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .faq-header {
      padding: 20px;
      border-bottom: 1px solid #F3F4F6;
    }

    .faq-header h3 {
      font-size: 16px;
      color: #111827;
    }

    .faq-table {
      width: 100%;
    }

    .faq-table th,
    .faq-table td {
      text-align: left;
      padding: 14px 20px;
    }

    .faq-frequency {
      background: #DBEAFE;
      color: #2563EB;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .faq-category {
      background: #F3F4F6;
      color: #6B7280;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
    }

    .contacts-section {
      background: white;
      border-radius: 12px;
    }

    .contacts-header {
      padding: 20px;
      border-bottom: 1px solid #F3F4F6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .contacts-header h3 {
      font-size: 16px;
      color: #111827;
    }

    .sentiment-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .sentiment-positive { background: #D1FAE5; color: #059669; }
    .sentiment-neutral { background: #F3F4F6; color: #6B7280; }
    .sentiment-negative { background: #FEE2E2; color: #EF4444; }

    .quality-score {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 600;
    }

    .quality-high { color: #059669; }
    .quality-medium { color: #D97706; }
    .quality-low { color: #EF4444; }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .header { flex-direction: column; gap: 12px; text-align: center; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .tabs { flex-wrap: wrap; }
      table { font-size: 12px; }
      th, td { padding: 10px 12px; }
      .config-grid { grid-template-columns: 1fr; }
      .results-grid { grid-template-columns: repeat(2, 1fr); }
      .goals-grid { grid-template-columns: 1fr; }
    }

    /* Chat Styles */
    .chat-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8B5CF6, #6366F1);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
      z-index: 1000;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .chat-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5);
    }

    .chat-panel {
      position: fixed;
      bottom: 100px;
      right: 24px;
      width: 420px;
      height: 600px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      z-index: 999;
      overflow: hidden;
    }

    .chat-panel.open {
      display: flex;
    }

    .chat-header {
      background: linear-gradient(135deg, #8B5CF6, #6366F1);
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header h3 {
      margin: 0;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      opacity: 0.8;
    }

    .chat-close:hover { opacity: 1; }

    .chat-stats {
      display: flex;
      gap: 16px;
      padding: 12px 20px;
      background: #F9FAFB;
      border-bottom: 1px solid #E5E7EB;
      font-size: 12px;
    }

    .chat-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .chat-stat-value {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }

    .chat-stat-label {
      color: #6B7280;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-message {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
    }

    .chat-message.user {
      background: #8B5CF6;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .chat-message.assistant {
      background: #F3F4F6;
      color: #111827;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .chat-message.assistant pre {
      background: #E5E7EB;
      padding: 8px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
    }

    .chat-message.typing {
      background: #F3F4F6;
      color: #6B7280;
    }

    .chat-message.typing::after {
      content: '...';
      animation: dots 1.5s infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .chat-input-container {
      padding: 16px;
      border-top: 1px solid #E5E7EB;
      display: flex;
      gap: 12px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #E5E7EB;
      border-radius: 24px;
      font-size: 14px;
      outline: none;
    }

    .chat-input:focus {
      border-color: #8B5CF6;
    }

    .chat-send {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #8B5CF6;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 18px;
    }

    .chat-send:hover { background: #7C3AED; }
    .chat-send:disabled { opacity: 0.5; cursor: not-allowed; }

    .chat-suggestions {
      padding: 8px 16px 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chat-suggestion {
      padding: 6px 12px;
      background: #EDE9FE;
      color: #7C3AED;
      border: none;
      border-radius: 16px;
      font-size: 12px;
      cursor: pointer;
    }

    .chat-suggestion:hover {
      background: #DDD6FE;
    }

    .sync-button {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #10B981;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .sync-button:hover { background: #059669; }
    .sync-button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Analyse Tab Styles */
    .analyse-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .analyse-title h2 {
      font-size: 24px;
      color: #111827;
      margin: 0 0 4px 0;
    }

    .analyse-subtitle {
      font-size: 14px;
      color: #6B7280;
      margin: 0;
    }

    .analyse-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .analyse-status {
      font-size: 13px;
      color: #6B7280;
    }

    .btn-refresh {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: #8B5CF6;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-refresh:hover { background: #7C3AED; }
    .btn-refresh:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-export-small {
      padding: 10px 16px;
      background: #F3F4F6;
      color: #374151;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-export-small:hover { background: #E5E7EB; }

    .status-filter {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      color: #6B7280;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      border-color: #8B5CF6;
      color: #8B5CF6;
    }

    .filter-btn.active {
      background: #8B5CF6;
      color: white;
      border-color: #8B5CF6;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-unterhaltung_laeuft { background: #D1FAE5; color: #059669; }
    .status-unterhaltung_abgebrochen { background: #FEE2E2; color: #EF4444; }
    .status-termin_gebucht { background: #DBEAFE; color: #2563EB; }
    .status-termin_angefragt { background: #FEF3C7; color: #D97706; }
    .status-simpli_interessiert { background: #EDE9FE; color: #7C3AED; }
    .status-simpli_nicht_interessiert { background: #F3F4F6; color: #6B7280; }
    .status-abgeschlossen { background: #F3F4F6; color: #374151; }

    .score-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
    }

    .score-high { background: #D1FAE5; color: #059669; }
    .score-medium { background: #FEF3C7; color: #D97706; }
    .score-low { background: #FEE2E2; color: #EF4444; }
    .score-none { background: #F3F4F6; color: #9CA3AF; }

    .suggestion-text {
      font-size: 13px;
      color: #374151;
      max-width: 300px;
    }

    .date-text {
      font-size: 12px;
      color: #6B7280;
    }

    .new-badge {
      display: inline-block;
      padding: 2px 6px;
      background: #FEF3C7;
      color: #D97706;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 6px;
    }

    .subaccount-select {
      padding: 8px 16px;
      border: 1px solid #E5E7EB;
      border-radius: 20px;
      font-size: 13px;
      color: #374151;
      background: white;
      cursor: pointer;
      margin-left: auto;
    }

    .subaccount-select:focus {
      outline: none;
      border-color: #8B5CF6;
    }

    #tab-analyse table {
      font-size: 14px;
    }

    #tab-analyse table th {
      white-space: nowrap;
    }

    #tab-analyse tbody tr {
      cursor: pointer;
      transition: background 0.2s;
    }

    #tab-analyse tbody tr:hover {
      background: #F3F4F6;
    }

    /* Conversation Modal */
    .conversation-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .conversation-modal.open {
      display: flex;
    }

    .conversation-modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }

    .conversation-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #E5E7EB;
    }

    .conversation-lead-info h3 {
      margin: 0;
      font-size: 18px;
      color: #111827;
    }

    .conversation-lead-meta {
      font-size: 13px;
      color: #6B7280;
    }

    .conversation-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #9CA3AF;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .conversation-close:hover {
      color: #374151;
    }

    .conversation-analysis {
      padding: 16px 24px;
      background: #F9FAFB;
      border-bottom: 1px solid #E5E7EB;
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }

    .analysis-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .analysis-item.suggestion {
      flex: 1;
      min-width: 200px;
    }

    .analysis-label {
      font-size: 12px;
      color: #6B7280;
      font-weight: 500;
    }

    .conversation-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .conv-message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
    }

    .conv-message.incoming {
      background: #F3F4F6;
      color: #374151;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .conv-message.outgoing {
      background: #8B5CF6;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .conv-message-time {
      font-size: 11px;
      margin-top: 4px;
      opacity: 0.7;
    }

    .conv-message.incoming .conv-message-time {
      color: #6B7280;
    }

    .conversation-messages .loading {
      text-align: center;
      color: #6B7280;
      padding: 40px;
    }

    .conversation-messages .empty {
      text-align: center;
      color: #9CA3AF;
      padding: 40px;
    }

    /* Filters Row */
    .filters-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .filter-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn-settings {
      padding: 8px 16px;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      color: #6B7280;
    }

    .btn-settings:hover {
      background: #F9FAFB;
      border-color: #8B5CF6;
      color: #8B5CF6;
    }

    /* Settings Modal */
    .settings-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .settings-modal.open {
      display: flex;
    }

    .settings-modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }

    .settings-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #E5E7EB;
    }

    .settings-modal-header h3 {
      margin: 0;
      font-size: 18px;
      color: #111827;
    }

    .settings-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #9CA3AF;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .settings-close:hover {
      color: #374151;
    }

    .settings-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .settings-group {
      margin-bottom: 24px;
    }

    .settings-group:last-child {
      margin-bottom: 0;
    }

    .settings-group label {
      display: block;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }

    .settings-hint {
      font-size: 13px;
      color: #6B7280;
      margin: 0 0 8px 0;
    }

    .settings-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
      line-height: 1.5;
    }

    .settings-group textarea:focus {
      outline: none;
      border-color: #8B5CF6;
    }

    .settings-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid #E5E7EB;
      background: #F9FAFB;
    }

    .btn-secondary {
      padding: 10px 20px;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #F3F4F6;
    }

    .btn-primary {
      padding: 10px 20px;
      background: #8B5CF6;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      color: white;
    }

    .btn-primary:hover {
      background: #7C3AED;
    }

    .hint-text {
      font-size: 13px;
      color: #6B7280;
      margin: 0 0 16px 0;
      padding: 12px;
      background: #FEF3C7;
      border-radius: 8px;
      border-left: 4px solid #F59E0B;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-copy {
      padding: 6px 12px;
      background: #F3F4F6;
      border: 1px solid #E5E7EB;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      color: #374151;
    }

    .btn-copy:hover {
      background: #E5E7EB;
    }

    .archive-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #6B7280;
      cursor: pointer;
    }

    .archive-toggle input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .archived-row {
      opacity: 0.6;
      background: #F9FAFB;
    }

    .archived-badge {
      display: inline-block;
      padding: 2px 6px;
      background: #9CA3AF;
      color: white;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 6px;
    }

    .btn-refresh-all {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: #F59E0B;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-refresh-all:hover { background: #D97706; }
    .btn-refresh-all:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Progress Modal */
    .progress-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1100;
      align-items: center;
      justify-content: center;
    }

    .progress-modal.open {
      display: flex;
    }

    .progress-modal-content {
      background: white;
      border-radius: 16px;
      padding: 32px 40px;
      text-align: center;
      min-width: 400px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }

    .progress-modal-content h3 {
      margin: 0 0 24px 0;
      font-size: 20px;
      color: #111827;
    }

    .progress-bar-container {
      width: 100%;
      height: 12px;
      background: #E5E7EB;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #8B5CF6, #6366F1);
      border-radius: 6px;
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #6B7280;
      margin-bottom: 12px;
    }

    .progress-details {
      font-size: 13px;
      color: #9CA3AF;
      min-height: 20px;
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div class="login-container" id="loginContainer">
    <div class="login-card">
      <h1>simpli.immo Admin</h1>
      <p>Melde dich an, um das Dashboard zu verwalten.</p>

      <div class="error-message" id="loginError" style="display: none;"></div>

      <form id="loginForm">
        <div class="form-group">
          <label>E-Mail</label>
          <input type="email" id="email" required placeholder="admin@example.com">
        </div>
        <div class="form-group">
          <label>Passwort</label>
          <input type="password" id="password" required placeholder="Passwort">
        </div>
        <button type="submit" class="btn btn-primary" id="loginBtn">Anmelden</button>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <header class="header">
      <h1>simpli.immo Admin Dashboard</h1>
      <div class="header-right">
        <span class="user-info" id="userEmail"></span>
        <button class="logout-btn" onclick="logout()">Abmelden</button>
      </div>
    </header>

    <main class="main-content">
      <!-- Stats -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="icon" style="background: #FFF7ED;">&#128274;</div>
          <div class="value" id="statWhitelist">0</div>
          <div class="label">Whitelist</div>
        </div>
        <div class="stat-card">
          <div class="icon" style="background: #D1FAE5;">&#128279;</div>
          <div class="value" id="statConnections">0</div>
          <div class="label">Verbindungen</div>
        </div>
        <div class="stat-card">
          <div class="icon" style="background: #DBEAFE;">&#128100;</div>
          <div class="value" id="statLeads">0</div>
          <div class="label">Leads</div>
        </div>
        <div class="stat-card">
          <div class="icon" style="background: #EDE9FE;">&#128172;</div>
          <div class="value" id="statMessages">0</div>
          <div class="label">Nachrichten</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('whitelist')">Whitelist</button>
        <button class="tab" onclick="switchTab('connections')">Verbindungen</button>
        <button class="tab" onclick="switchTab('analyse')">&#128202; Analyse</button>
      </div>

      <!-- Whitelist Tab -->
      <div class="tab-content active" id="tab-whitelist">
        <div class="card">
          <div class="card-header">
            <h2>Freigegebene Subaccounts</h2>
            <button class="btn btn-primary" style="width: auto; padding: 10px 20px;" onclick="openAddModal()">
              + Hinzufugen
            </button>
          </div>
          <div class="card-body">
            <table>
              <thead>
                <tr>
                  <th>Location</th>
                  <th>Firma</th>
                  <th>Status</th>
                  <th>Erstellt</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody id="whitelistTable">
                <tr><td colspan="5" class="empty-state">Laden...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Connections Tab -->
      <div class="tab-content" id="tab-connections">
        <!-- Pending Connections -->
        <div class="card" id="pendingConnectionsCard" style="display: none;">
          <div class="card-header">
            <h2>&#9203; Wartend auf Verbindung</h2>
            <span class="badge badge-warning" id="pendingCount">0</span>
          </div>
          <div class="card-body">
            <p class="hint-text">Diese Accounts sind in der Whitelist, aber noch nicht verbunden. Der Nutzer muss die App im GHL Marketplace installieren.</p>
            <table>
              <thead>
                <tr>
                  <th>Location Name</th>
                  <th>Location ID</th>
                  <th>Unternehmen</th>
                  <th>Hinzugefügt am</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody id="pendingConnectionsTable">
                <tr><td colspan="5" class="empty-state">Keine wartenden Verbindungen</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Active Connections -->
        <div class="card">
          <div class="card-header">
            <h2>&#9989; Aktive Verbindungen</h2>
          </div>
          <div class="card-body">
            <table>
              <thead>
                <tr>
                  <th>Location</th>
                  <th>User ID</th>
                  <th>Status</th>
                  <th>Letzter Sync</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody id="connectionsTable">
                <tr><td colspan="5" class="empty-state">Laden...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Analyse Tab -->
      <div class="tab-content" id="tab-analyse">
        <!-- Header with Refresh Button -->
        <div class="analyse-header">
          <div class="analyse-title">
            <h2>&#128202; Lead-Analyse</h2>
            <p class="analyse-subtitle">Alle Leads werden automatisch angelegt. Klicke "Aktualisieren" um Leads mit neuen Nachrichten neu zu analysieren.</p>
          </div>
          <div class="analyse-actions">
            <span class="analyse-status" id="analyseStatus"></span>
            <button class="btn-refresh" id="refreshBtn" onclick="refreshAnalysis(false)">
              <span id="refreshBtnText">&#8635; Neue analysieren</span>
            </button>
            <button class="btn-refresh-all" id="refreshAllBtn" onclick="refreshAnalysis(true)">
              <span id="refreshAllBtnText">&#128260; Alle neu analysieren</span>
            </button>
            <button class="btn-export-small" onclick="exportLeadsCSV()">&#128190; Export</button>
          </div>
        </div>

        <!-- Summary Stats -->
        <div class="results-grid">
          <div class="result-card">
            <div class="label">Gesamt Leads</div>
            <div class="value" id="analyseTotal">-</div>
            <div class="subvalue">Alle Subaccounts</div>
          </div>
          <div class="result-card">
            <div class="label">KI-Qualität</div>
            <div class="value" id="analyseQuality">-</div>
            <div class="subvalue">Durchschnitt (1-10)</div>
          </div>
          <div class="result-card">
            <div class="label">Brauchen Aufmerksamkeit</div>
            <div class="value" id="analyseAttention">-</div>
            <div class="subvalue">Abgebrochen oder Score &lt;5</div>
          </div>
          <div class="result-card">
            <div class="label">Noch nicht analysiert</div>
            <div class="value" id="analyseNotAnalyzed">-</div>
            <div class="subvalue">Neue Nachrichten</div>
          </div>
        </div>

        <!-- Filters Row -->
        <div class="filters-row">
          <div class="status-filter">
            <button class="filter-btn active" data-filter="alle" onclick="filterLeads('alle')">Alle</button>
            <button class="filter-btn" data-filter="unterhaltung_laeuft" onclick="filterLeads('unterhaltung_laeuft')">&#128994; Läuft</button>
            <button class="filter-btn" data-filter="unterhaltung_abgebrochen" onclick="filterLeads('unterhaltung_abgebrochen')">&#128308; Abgebrochen</button>
            <button class="filter-btn" data-filter="termin_gebucht" onclick="filterLeads('termin_gebucht')">&#9989; Termin</button>
            <button class="filter-btn" data-filter="simpli_interessiert" onclick="filterLeads('simpli_interessiert')">&#128176; Simpli</button>
            <button class="filter-btn" data-filter="attention" onclick="filterLeads('attention')">&#9888; Aufmerksamkeit</button>
          </div>
          <div class="filter-controls">
            <label class="archive-toggle">
              <input type="checkbox" id="showArchived" onchange="toggleArchived()">
              <span>Archivierte anzeigen</span>
            </label>
            <select id="subaccountFilter" class="subaccount-select" onchange="filterBySubaccount(this.value)">
              <option value="alle">Alle Makler</option>
            </select>
            <button class="btn-settings" onclick="openAnalyseSettings()">&#9881; Prompts</button>
          </div>
        </div>

        <!-- Leads Table -->
        <div class="card">
          <div class="card-body">
            <table>
              <thead>
                <tr>
                  <th>Lead</th>
                  <th>Makler</th>
                  <th>Status</th>
                  <th>KI-Score</th>
                  <th>Verbesserungsvorschlag</th>
                  <th>Letzte Nachricht</th>
                  <th>Analysiert</th>
                </tr>
              </thead>
              <tbody id="leadsAnalyseTable">
                <tr><td colspan="7" class="empty-state">Laden...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Analysis Progress Modal -->
  <div class="progress-modal" id="analysisProgressModal">
    <div class="progress-modal-content">
      <h3>&#129302; Analyse läuft...</h3>
      <div class="progress-bar-container">
        <div class="progress-bar" id="analysisProgressBar"></div>
      </div>
      <div class="progress-text">
        <span id="analysisProgressText">0 von 0 Leads</span>
        <span id="analysisProgressPercent">0%</span>
      </div>
      <div class="progress-details" id="analysisProgressDetails">
        Starte Analyse...
      </div>
    </div>
  </div>

  <!-- Analyse Settings Modal -->
  <div class="settings-modal" id="analyseSettingsModal">
    <div class="settings-modal-content">
      <div class="settings-modal-header">
        <h3>&#9881; Analyse-Prompts anpassen</h3>
        <button class="settings-close" onclick="closeAnalyseSettings()">&times;</button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-group">
          <label>Status-Bewertung</label>
          <p class="settings-hint">Wie soll der Konversations-Status bestimmt werden?</p>
          <textarea id="promptStatus" rows="4">Bestimme den Status basierend auf:
- unterhaltung_laeuft: Aktiver Dialog, Kunde antwortet regelmäßig
- unterhaltung_abgebrochen: Keine Kundenantwort seit >3 Tagen
- termin_gebucht: Kunde hat Besichtigungs-/Beratungstermin bestätigt
- termin_angefragt: Kunde fragt nach Termin oder Rückruf
- simpli_interessiert: Kunde zeigt Interesse an Finanzierung
- simpli_nicht_interessiert: Kunde lehnt Finanzierung ab
- abgeschlossen: Gespräch ist beendet (Kauf, Absage, etc.)</textarea>
        </div>
        <div class="settings-group">
          <label>KI-Score Bewertung (1-10)</label>
          <p class="settings-hint">Nach welchen Kriterien soll die KI-Qualität bewertet werden?</p>
          <textarea id="promptScore" rows="4">Bewerte die KI-Qualität (1-10) basierend auf:
1. Wurden alle Fragen des Kunden vollständig beantwortet?
2. War die KI höflich und professionell?
3. Hat die KI aktiv versucht, einen Termin zu vereinbaren?
4. Wurden Einwände des Kunden professionell behandelt?
5. Wurde Simpli Finance bei Finanzierungsfragen erwähnt?</textarea>
        </div>
        <div class="settings-group">
          <label>Verbesserungsvorschläge</label>
          <p class="settings-hint">Welche Art von Verbesserungsvorschlägen soll die KI geben?</p>
          <textarea id="promptImprovement" rows="4">Gib konkrete Verbesserungsvorschläge wie:
- "Die KI sollte aktiver nach einem Besichtigungstermin fragen"
- "Bei Finanzierungsfragen Simpli Finance erwähnen"
- "Schneller auf Kundenanfragen reagieren"
- "Mehr Details zum Objekt bereitstellen"
- "Professioneller auf Preisverhandlungen eingehen"</textarea>
        </div>
      </div>
      <div class="settings-modal-footer">
        <button class="btn-secondary" onclick="closeAnalyseSettings()">Abbrechen</button>
        <button class="btn-primary" onclick="saveAnalyseSettings()">Speichern</button>
      </div>
    </div>
  </div>

  <!-- Conversation Modal -->
  <div class="conversation-modal" id="conversationModal">
    <div class="conversation-modal-content">
      <div class="conversation-modal-header">
        <div class="conversation-lead-info">
          <h3 id="conversationLeadName">Lead Name</h3>
          <span class="conversation-lead-meta" id="conversationLeadMeta">Email • Makler</span>
        </div>
        <button class="conversation-close" onclick="closeConversation()">&times;</button>
      </div>
      <div class="conversation-analysis" id="conversationAnalysis">
        <div class="analysis-item">
          <span class="analysis-label">Status:</span>
          <span class="status-badge" id="convStatus">-</span>
        </div>
        <div class="analysis-item">
          <span class="analysis-label">KI-Score:</span>
          <span class="score-badge" id="convScore">-</span>
        </div>
        <div class="analysis-item suggestion">
          <span class="analysis-label">Verbesserung:</span>
          <span id="convSuggestion">-</span>
        </div>
      </div>
      <div class="conversation-messages" id="conversationMessages">
        <div class="loading">Lade Nachrichten...</div>
      </div>
    </div>
  </div>

  <!-- Chat FAB Button -->
  <button class="chat-fab" id="chatFab" onclick="toggleChat()" style="display: none;">
    &#128172;
  </button>

  <!-- Chat Panel -->
  <div class="chat-panel" id="chatPanel">
    <div class="chat-header">
      <h3>&#129302; KI-Assistent</h3>
      <button class="chat-close" onclick="toggleChat()">&times;</button>
    </div>
    <div class="chat-stats" id="chatStats">
      <div class="chat-stat">
        <span class="chat-stat-value" id="chatStatLeads">-</span>
        <span class="chat-stat-label">Leads</span>
      </div>
      <div class="chat-stat">
        <span class="chat-stat-value" id="chatStatQuality">-</span>
        <span class="chat-stat-label">KI-Score</span>
      </div>
      <div class="chat-stat">
        <span class="chat-stat-value" id="chatStatAttention">-</span>
        <span class="chat-stat-label">Aktion nötig</span>
      </div>
      <button class="sync-button" id="syncBtn" onclick="syncAndAnalyze()">
        &#8635; Sync
      </button>
    </div>
    <div class="chat-suggestions" id="chatSuggestions">
      <button class="chat-suggestion" onclick="askQuestion('Welche Leads brauchen dringend Aufmerksamkeit?')">Aufmerksamkeit nötig?</button>
      <button class="chat-suggestion" onclick="askQuestion('Was sind die häufigsten Verbesserungsvorschläge für unsere KI?')">Verbesserungen</button>
      <button class="chat-suggestion" onclick="askQuestion('Zeig mir eine Zusammenfassung aller Leads')">Zusammenfassung</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-message assistant">
        Hallo! Ich bin dein KI-Assistent für das Lead-Management. Ich habe Zugriff auf alle Konversationen und Analysen. Was möchtest du wissen?
      </div>
    </div>
    <div class="chat-input-container">
      <input type="text" class="chat-input" id="chatInput" placeholder="Frage stellen..." onkeypress="handleChatKeypress(event)">
      <button class="chat-send" id="chatSendBtn" onclick="sendChatMessage()">&#10148;</button>
    </div>
  </div>

  <!-- Add Modal -->
  <div class="modal-overlay hidden" id="addModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Subaccount hinzufugen</h3>
        <button class="modal-close" onclick="closeAddModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="addForm">
          <div class="form-group">
            <label>Location ID *</label>
            <input type="text" id="addLocationId" required placeholder="z.B. tiC9FckRBUxhbaleTYma">
          </div>
          <div class="form-group">
            <label>Location Name</label>
            <input type="text" id="addLocationName" placeholder="z.B. Immobilien Muller">
          </div>
          <div class="form-group">
            <label>Firmenname</label>
            <input type="text" id="addCompanyName" placeholder="z.B. Muller Immobilien GmbH">
          </div>
          <div class="form-group">
            <label>Kontakt E-Mail</label>
            <input type="email" id="addContactEmail" placeholder="kontakt@example.com">
          </div>
          <div class="form-group">
            <label>Notizen</label>
            <textarea id="addNotes" rows="3" style="width: 100%; padding: 12px; border: 1px solid #E5E7EB; border-radius: 10px; resize: vertical;"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddModal()">Abbrechen</button>
        <button class="btn btn-primary" onclick="addSubaccount()">Hinzufugen</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase Config
    const SUPABASE_URL = 'https://hsfrdovpgxtqbitmkrhs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzZnJkb3ZwZ3h0cWJpdG1rcmhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MjM2MjQsImV4cCI6MjA4MTQ5OTYyNH0.GQhnvrYlcCcx0qZg0-yVolu5J5aa9RwyNxW-gG4ccsk';

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;

    // Check auth on load
    async function checkAuth() {
      const { data: { session } } = await supabaseClient.auth.getSession();

      if (session?.user) {
        // Check if user is admin
        const { data: adminData } = await supabaseClient
          .from('admin_users')
          .select('role')
          .eq('user_id', session.user.id)
          .single();

        if (adminData) {
          currentUser = session.user;
          showDashboard();
          loadData();
        } else {
          showError('Du hast keine Admin-Berechtigung.');
          await supabaseClient.auth.signOut();
        }
      }
    }

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const loginBtn = document.getElementById('loginBtn');

      loginBtn.disabled = true;
      loginBtn.textContent = 'Anmelden...';
      hideError();

      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password
        });

        if (error) throw error;

        // Check admin status
        const { data: adminData, error: adminError } = await supabaseClient
          .from('admin_users')
          .select('role')
          .eq('user_id', data.user.id)
          .single();

        if (adminError || !adminData) {
          await supabaseClient.auth.signOut();
          throw new Error('Du hast keine Admin-Berechtigung.');
        }

        currentUser = data.user;
        showDashboard();
        loadData();

      } catch (err) {
        showError(err.message);
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Anmelden';
      }
    });

    // Logout
    async function logout() {
      await supabaseClient.auth.signOut();
      currentUser = null;
      document.getElementById('dashboard').classList.remove('active');
      document.getElementById('loginContainer').classList.remove('hidden');
    }

    // Show/Hide
    function showDashboard() {
      document.getElementById('loginContainer').classList.add('hidden');
      document.getElementById('dashboard').classList.add('active');
      document.getElementById('userEmail').textContent = currentUser.email;
    }

    function showError(msg) {
      const el = document.getElementById('loginError');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function hideError() {
      document.getElementById('loginError').style.display = 'none';
    }

    // Tab switching
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    // Load data
    async function loadData() {
      await Promise.all([
        loadStats(),
        loadWhitelist(),
        loadConnections()
      ]);
    }

    async function loadStats() {
      const [whitelist, connections, leads, messages] = await Promise.all([
        supabaseClient.from('approved_subaccounts').select('id', { count: 'exact' }),
        supabaseClient.from('ghl_connections').select('id', { count: 'exact' }).eq('is_active', true),
        supabaseClient.from('leads').select('id', { count: 'exact' }),
        supabaseClient.from('messages').select('id', { count: 'exact' })
      ]);

      document.getElementById('statWhitelist').textContent = whitelist.count || 0;
      document.getElementById('statConnections').textContent = connections.count || 0;
      document.getElementById('statLeads').textContent = leads.count || 0;
      document.getElementById('statMessages').textContent = messages.count || 0;
    }

    async function loadWhitelist() {
      const { data, error } = await supabaseClient
        .from('approved_subaccounts')
        .select('*')
        .order('created_at', { ascending: false });

      const tbody = document.getElementById('whitelistTable');

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="icon">&#128274;</div>Keine Subaccounts in der Whitelist</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(sub => `
        <tr>
          <td>
            <strong>${sub.location_name || 'Unbenannt'}</strong><br>
            <small style="color: #6B7280;">${sub.location_id.substring(0, 20)}...</small>
          </td>
          <td>${sub.company_name || '-'}</td>
          <td>
            <span class="badge ${sub.is_active ? 'badge-success' : 'badge-danger'}">
              ${sub.is_active ? 'Aktiv' : 'Inaktiv'}
            </span>
          </td>
          <td>${new Date(sub.created_at).toLocaleDateString('de-DE')}</td>
          <td>
            <div class="actions">
              <button class="action-btn toggle" onclick="toggleSubaccount('${sub.id}', ${!sub.is_active})">
                ${sub.is_active ? 'Deaktivieren' : 'Aktivieren'}
              </button>
              <button class="action-btn delete" onclick="deleteSubaccount('${sub.id}')">Loschen</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    async function loadConnections() {
      // Load both connections and whitelist to find pending ones
      const [connectionsResult, whitelistResult] = await Promise.all([
        supabaseClient.from('ghl_connections').select('*').order('created_at', { ascending: false }),
        supabaseClient.from('approved_subaccounts').select('*').eq('is_active', true)
      ]);

      const connections = connectionsResult.data || [];
      const whitelist = whitelistResult.data || [];

      // Find connected location_ids
      const connectedLocationIds = new Set(connections.map(c => c.location_id));

      // Find pending (whitelisted but not connected)
      const pending = whitelist.filter(w => !connectedLocationIds.has(w.location_id));

      // Render pending connections
      const pendingCard = document.getElementById('pendingConnectionsCard');
      const pendingTbody = document.getElementById('pendingConnectionsTable');
      const pendingCount = document.getElementById('pendingCount');

      if (pending.length > 0) {
        pendingCard.style.display = 'block';
        pendingCount.textContent = pending.length;
        pendingTbody.innerHTML = pending.map(p => `
          <tr>
            <td><strong>${p.location_name || 'Unbenannt'}</strong></td>
            <td>
              <code style="font-size: 11px; background: #F3F4F6; padding: 2px 6px; border-radius: 4px;">${p.location_id}</code>
              <button class="btn-copy" onclick="copyToClipboard('${p.location_id}')" title="Kopieren">&#128203;</button>
            </td>
            <td>${p.company_name || '-'}</td>
            <td>${new Date(p.created_at).toLocaleDateString('de-DE')}</td>
            <td>
              <button class="action-btn toggle" onclick="connectSubaccount('${p.location_id}')">&#128279; Verbinden</button>
            </td>
          </tr>
        `).join('');
      } else {
        pendingCard.style.display = 'none';
      }

      // Render active connections
      const tbody = document.getElementById('connectionsTable');

      if (connections.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="icon">&#128279;</div>Keine Verbindungen</td></tr>';
        return;
      }

      tbody.innerHTML = connections.map(conn => `
        <tr>
          <td>
            <strong>${conn.location_name || 'Unbenannt'}</strong><br>
            <small style="color: #6B7280;">${conn.location_id}</small>
          </td>
          <td><small>${conn.user_id.substring(0, 8)}...</small></td>
          <td>
            <span class="badge ${conn.is_active ? 'badge-success' : 'badge-danger'}">
              ${conn.is_active ? 'Aktiv' : 'Getrennt'}
            </span>
          </td>
          <td>${conn.last_sync_at ? new Date(conn.last_sync_at).toLocaleString('de-DE') : '-'}</td>
          <td>
            <div class="actions">
              ${conn.is_active ? `
                <button class="action-btn" onclick="syncConnection('${conn.user_id}')" title="Kontakte synchronisieren">&#128260; Sync</button>
                <button class="action-btn delete" onclick="disconnectConnection('${conn.id}')">Trennen</button>
              ` : `
                <button class="action-btn toggle" onclick="reconnectConnection('${conn.id}')">Reconnect</button>
              `}
            </div>
          </td>
        </tr>
      `).join('');
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text);
      alert('Location ID kopiert!');
    }

    async function connectSubaccount(locationId) {
      if (!confirm(`Subaccount ${locationId} jetzt verbinden?`)) return;

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();

        const response = await fetch(`${SUPABASE_URL}/functions/v1/connect-subaccount`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({ location_id: locationId })
        });

        const result = await response.json();

        if (result.success) {
          alert(`✅ ${result.message}\n\nLocation: ${result.location_name || locationId}`);
          // Reload connections to show the new one
          await loadConnections();
          await loadStats();
        } else {
          alert('❌ Fehler: ' + result.error);
        }
      } catch (error) {
        alert('❌ Verbindungsfehler: ' + error.message);
      }
    }

    async function syncConnection(userId) {
      const statusEl = document.getElementById('analyseStatus');
      statusEl.textContent = '🔄 Synchronisiere Kontakte...';

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();

        const response = await fetch(`${SUPABASE_URL}/functions/v1/ghl-sync`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            user_id: userId,
            sync_type: 'full'
          })
        });

        const result = await response.json();

        if (result.success || result.connections) {
          const contacts = result.results?.[0]?.contacts || { synced: 0, errors: 0 };
          const conversations = result.results?.[0]?.conversations || { synced: 0, errors: 0 };

          statusEl.textContent = `✅ Sync: ${contacts.synced} Kontakte, ${conversations.synced} Konversationen`;

          // Reload data
          await loadConnections();
          await loadLeadsAnalyse();
          await loadStats();

          setTimeout(() => { statusEl.textContent = ''; }, 5000);
        } else {
          statusEl.textContent = '❌ Sync fehlgeschlagen: ' + (result.error || 'Unbekannt');
        }
      } catch (error) {
        statusEl.textContent = '❌ Sync Fehler: ' + error.message;
      }
    }

    // Actions
    async function toggleSubaccount(id, isActive) {
      await supabaseClient
        .from('approved_subaccounts')
        .update({ is_active: isActive, updated_at: new Date().toISOString() })
        .eq('id', id);

      loadWhitelist();
      loadStats();
    }

    async function deleteSubaccount(id) {
      if (!confirm('Subaccount wirklich loschen?')) return;

      await supabaseClient
        .from('approved_subaccounts')
        .delete()
        .eq('id', id);

      loadWhitelist();
      loadStats();
    }

    async function disconnectConnection(id) {
      if (!confirm('Verbindung trennen?\n\nAlle Leads dieses Accounts werden archiviert und nicht mehr analysiert.')) return;

      // Get connection to find user_id
      const { data: connection } = await supabaseClient
        .from('ghl_connections')
        .select('user_id')
        .eq('id', id)
        .single();

      if (connection) {
        // Archive all leads for this connection
        await supabaseClient
          .from('leads')
          .update({ is_archived: true })
          .eq('user_id', connection.user_id);
      }

      // Deactivate connection
      await supabaseClient
        .from('ghl_connections')
        .update({ is_active: false })
        .eq('id', id);

      loadConnections();
      loadStats();
      loadLeadsAnalyse(); // Refresh leads list
    }

    async function reconnectConnection(id) {
      await supabaseClient
        .from('ghl_connections')
        .update({ is_active: true })
        .eq('id', id);

      loadConnections();
      loadStats();
    }

    // Modal
    function openAddModal() {
      document.getElementById('addModal').classList.remove('hidden');
    }

    function closeAddModal() {
      document.getElementById('addModal').classList.add('hidden');
      document.getElementById('addForm').reset();
    }

    async function addSubaccount() {
      const locationId = document.getElementById('addLocationId').value.trim();

      if (!locationId) {
        alert('Location ID ist erforderlich');
        return;
      }

      const { error } = await supabaseClient
        .from('approved_subaccounts')
        .insert({
          location_id: locationId,
          location_name: document.getElementById('addLocationName').value.trim() || null,
          company_name: document.getElementById('addCompanyName').value.trim() || null,
          contact_email: document.getElementById('addContactEmail').value.trim() || null,
          notes: document.getElementById('addNotes').value.trim() || null,
          is_active: true,
          approved_by: currentUser.id
        });

      if (error) {
        alert('Fehler: ' + error.message);
        return;
      }

      closeAddModal();
      loadWhitelist();
      loadStats();
    }

    // ========== ANALYSIS FUNCTIONS ==========
    let analysisData = null;

    async function startAnalysis() {
      const btn = document.getElementById('analyzeBtn');
      const btnText = document.getElementById('analyzeBtnText');
      const spinner = document.getElementById('analyzeSpinner');
      const status = document.getElementById('analysisStatus');

      btn.disabled = true;
      btnText.textContent = 'Analysiere...';
      spinner.style.display = 'block';
      status.textContent = 'Lade Konversationen und analysiere mit KI...';

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();

        const response = await fetch(`${SUPABASE_URL}/functions/v1/analyze-conversations`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            analysis_prompt: document.getElementById('analysisPrompt').value,
            time_filter: document.getElementById('timeFilter').value,
            goal_a: document.getElementById('goalA').value,
            goal_b: document.getElementById('goalB').value
          })
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'Analyse fehlgeschlagen');
        }

        analysisData = result;
        displayResults(result);

        status.textContent = `Analyse abgeschlossen: ${result.analyses?.length || 0} Konversationen analysiert.`;
        document.getElementById('exportBtn').style.display = 'block';

      } catch (error) {
        console.error('Analysis error:', error);
        status.textContent = 'Fehler: ' + error.message;
      } finally {
        btn.disabled = false;
        btnText.textContent = '▶ Analyse starten';
        spinner.style.display = 'none';
      }
    }

    function displayResults(data) {
      const resultsDiv = document.getElementById('analysisResults');
      resultsDiv.style.display = 'block';

      const summary = data.summary || {};
      const analyses = data.analyses || [];
      const faqs = data.faqs || [];

      // Summary stats
      document.getElementById('resultTotal').textContent = summary.total_analyzed || 0;
      document.getElementById('resultQuality').textContent = summary.avg_quality_score || '-';
      document.getElementById('resultUnanswered').textContent = summary.unanswered_questions_total || 0;

      // Sentiment
      const sentiment = summary.sentiment_breakdown || {};
      const totalSent = (sentiment.positive || 0) + (sentiment.neutral || 0) + (sentiment.negative || 0);
      if (totalSent > 0) {
        const positivePercent = Math.round((sentiment.positive / totalSent) * 100);
        document.getElementById('resultSentiment').textContent = positivePercent + '%';
        document.getElementById('resultSentimentDetail').textContent =
          `${sentiment.positive} positiv, ${sentiment.neutral} neutral, ${sentiment.negative} negativ`;
      }

      // Goal A
      const goalA = summary.goal_a || {};
      document.getElementById('goalAName').textContent = goalA.name || 'Ziel A';
      document.getElementById('goalAAchieved').textContent = goalA.achieved || 0;
      document.getElementById('goalABlocked').textContent = goalA.blocked || 0;

      const goalABlockers = goalA.top_blockers || [];
      if (goalABlockers.length > 0) {
        document.getElementById('goalABlockersList').innerHTML = goalABlockers.map(b => `
          <div class="blocker-item">
            <span>${b.blocker}</span>
            <span class="blocker-count">${b.count}x</span>
          </div>
        `).join('');
      } else {
        document.getElementById('goalABlockersList').innerHTML = '<em>Keine Blocker identifiziert</em>';
      }

      // Goal B
      const goalB = summary.goal_b || {};
      document.getElementById('goalBName').textContent = goalB.name || 'Ziel B';
      document.getElementById('goalBAchieved').textContent = goalB.achieved || 0;
      document.getElementById('goalBBlocked').textContent = goalB.blocked || 0;

      const goalBBlockers = goalB.top_blockers || [];
      if (goalBBlockers.length > 0) {
        document.getElementById('goalBBlockersList').innerHTML = goalBBlockers.map(b => `
          <div class="blocker-item">
            <span>${b.blocker}</span>
            <span class="blocker-count">${b.count}x</span>
          </div>
        `).join('');
      } else {
        document.getElementById('goalBBlockersList').innerHTML = '<em>Keine Blocker identifiziert</em>';
      }

      // FAQ Table
      const faqTable = document.getElementById('faqTable');
      if (faqs.length > 0) {
        faqTable.innerHTML = faqs.slice(0, 20).map(faq => `
          <tr>
            <td>${faq.question}</td>
            <td><span class="faq-category">${faq.category}</span></td>
            <td><span class="faq-frequency">${faq.frequency}x</span></td>
          </tr>
        `).join('');
      } else {
        faqTable.innerHTML = '<tr><td colspan="3" class="empty-state">Keine Fragen gefunden</td></tr>';
      }

      // Contacts Table
      document.getElementById('contactsCount').textContent = `${analyses.length} Kontakte`;
      const contactsTable = document.getElementById('contactsTable');

      if (analyses.length > 0) {
        contactsTable.innerHTML = analyses.map(a => `
          <tr>
            <td><strong>${a.contact_name}</strong></td>
            <td>${a.location_name}</td>
            <td>
              <span class="quality-score ${getQualityClass(a.ai_quality_score)}">
                ${a.ai_quality_score}/10
              </span>
            </td>
            <td><span class="sentiment-badge sentiment-${a.sentiment}">${getSentimentLabel(a.sentiment)}</span></td>
            <td><span class="badge ${getStatusBadge(a.goal_a_status)}">${getStatusLabel(a.goal_a_status)}</span></td>
            <td><span class="badge ${getStatusBadge(a.goal_b_status)}">${getStatusLabel(a.goal_b_status)}</span></td>
            <td>${a.message_count}</td>
          </tr>
        `).join('');
      } else {
        contactsTable.innerHTML = '<tr><td colspan="7" class="empty-state">Keine Kontakte analysiert</td></tr>';
      }
    }

    function getQualityClass(score) {
      if (score >= 7) return 'quality-high';
      if (score >= 4) return 'quality-medium';
      return 'quality-low';
    }

    function getSentimentLabel(sentiment) {
      const labels = { positive: 'Positiv', neutral: 'Neutral', negative: 'Negativ' };
      return labels[sentiment] || sentiment;
    }

    function getStatusBadge(status) {
      const badges = {
        achieved: 'badge-success',
        in_progress: 'badge-warning',
        blocked: 'badge-danger',
        not_applicable: ''
      };
      return badges[status] || '';
    }

    function getStatusLabel(status) {
      const labels = {
        achieved: 'Erreicht',
        in_progress: 'In Arbeit',
        blocked: 'Blockiert',
        not_applicable: 'N/A'
      };
      return labels[status] || status;
    }

    function exportResults() {
      if (!analysisData || !analysisData.analyses) {
        alert('Keine Daten zum Exportieren');
        return;
      }

      const analyses = analysisData.analyses;
      const headers = ['Kontakt', 'Subaccount', 'KI-Score', 'Sentiment', 'Ziel A', 'Ziel B', 'Nachrichten', 'Zusammenfassung'];
      const rows = analyses.map(a => [
        a.contact_name,
        a.location_name,
        a.ai_quality_score,
        a.sentiment,
        a.goal_a_status,
        a.goal_b_status,
        a.message_count,
        `"${(a.summary || '').replace(/"/g, '""')}"`
      ]);

      const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `analyse_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();

      URL.revokeObjectURL(url);
    }

    // ========== CHAT FUNCTIONS ==========
    let chatHistory = [];
    let chatOpen = false;

    function toggleChat() {
      chatOpen = !chatOpen;
      document.getElementById('chatPanel').classList.toggle('open', chatOpen);
    }

    function handleChatKeypress(event) {
      if (event.key === 'Enter') {
        sendChatMessage();
      }
    }

    function askQuestion(question) {
      document.getElementById('chatInput').value = question;
      sendChatMessage();
    }

    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();

      if (!message) return;

      input.value = '';
      input.disabled = true;
      document.getElementById('chatSendBtn').disabled = true;

      // Add user message
      const messagesDiv = document.getElementById('chatMessages');
      messagesDiv.innerHTML += `<div class="chat-message user">${escapeHtml(message)}</div>`;
      messagesDiv.innerHTML += `<div class="chat-message assistant typing" id="typingIndicator">Analysiere</div>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      // Add to history
      chatHistory.push({ role: 'user', content: message });

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();

        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            message,
            history: chatHistory.slice(-10) // Last 10 messages for context
          })
        });

        const result = await response.json();

        // Remove typing indicator
        document.getElementById('typingIndicator')?.remove();

        if (result.success) {
          // Add assistant message
          const formattedMessage = formatMarkdown(result.message);
          messagesDiv.innerHTML += `<div class="chat-message assistant">${formattedMessage}</div>`;
          chatHistory.push({ role: 'assistant', content: result.message });

          // Update stats if available
          if (result.stats) {
            document.getElementById('chatStatLeads').textContent = result.stats.total_leads || '-';
            document.getElementById('chatStatQuality').textContent = result.stats.avg_quality || '-';
            document.getElementById('chatStatAttention').textContent = result.stats.needs_attention || '-';
          }
        } else {
          messagesDiv.innerHTML += `<div class="chat-message assistant">Fehler: ${result.error}</div>`;
        }
      } catch (error) {
        document.getElementById('typingIndicator')?.remove();
        messagesDiv.innerHTML += `<div class="chat-message assistant">Fehler bei der Anfrage: ${error.message}</div>`;
      }

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      input.disabled = false;
      document.getElementById('chatSendBtn').disabled = false;
      input.focus();
    }

    async function syncAndAnalyze() {
      const btn = document.getElementById('syncBtn');
      btn.disabled = true;
      btn.innerHTML = '&#8635; Sync läuft...';

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();

        const response = await fetch(`${SUPABASE_URL}/functions/v1/sync-analyze-leads`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({ force_all: false })
        });

        const result = await response.json();

        if (result.success) {
          // Add result to chat
          const messagesDiv = document.getElementById('chatMessages');
          let summaryText = `✅ Sync abgeschlossen: ${result.analyzed} Leads analysiert.`;

          if (result.summary) {
            summaryText += `\n\nDurchschnittliche KI-Qualität: ${result.summary.avg_quality_score}/10`;
            summaryText += `\nBrauchen Aufmerksamkeit: ${result.summary.needs_attention}`;

            // Update stats
            document.getElementById('chatStatLeads').textContent = result.analyzed || '-';
            document.getElementById('chatStatQuality').textContent = result.summary.avg_quality_score || '-';
            document.getElementById('chatStatAttention').textContent = result.summary.needs_attention || '-';
          }

          messagesDiv.innerHTML += `<div class="chat-message assistant">${escapeHtml(summaryText)}</div>`;
          messagesDiv.scrollTop = messagesDiv.scrollHeight;

          // Reload dashboard stats
          loadStats();
        } else {
          alert('Sync fehlgeschlagen: ' + result.error);
        }
      } catch (error) {
        alert('Sync Fehler: ' + error.message);
      }

      btn.disabled = false;
      btn.innerHTML = '&#8635; Sync';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatMarkdown(text) {
      // Basic markdown formatting
      return escapeHtml(text)
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>');
    }

    // Show chat FAB when dashboard loads
    function showChatFab() {
      document.getElementById('chatFab').style.display = 'flex';
    }

    // Update showDashboard to also show chat FAB
    const originalShowDashboard = showDashboard;
    showDashboard = function() {
      originalShowDashboard();
      showChatFab();
    };

    // ========== LEADS ANALYSE FUNCTIONS ==========
    let allLeadsData = [];
    let allSubaccounts = [];
    let currentFilter = 'alle';
    let currentSubaccountFilter = 'alle';
    let showArchivedFilter = false;

    async function loadLeadsAnalyse() {
      try {
        // Load all leads (including archived for filtering)
        const { data: leads, error: leadsError } = await supabaseClient
          .from('leads')
          .select('id, name, email, phone, status, created_at, user_id, conversation_status, ai_quality_score, ai_improvement_suggestion, last_message_at, last_analyzed_at, is_archived')
          .order('last_message_at', { ascending: false, nullsFirst: false });

        if (leadsError) throw leadsError;

        // Load all connections to get location info
        const { data: connections, error: connError } = await supabaseClient
          .from('ghl_connections')
          .select('user_id, location_id, location_name')
          .eq('is_active', true);

        if (connError) throw connError;

        // Create lookup map
        const connectionMap = new Map();
        (connections || []).forEach(c => {
          connectionMap.set(c.user_id, c);
        });

        // Merge leads with connection info
        allLeadsData = (leads || []).map(lead => ({
          ...lead,
          ghl_connections: connectionMap.get(lead.user_id) || null
        }));

        // Extract unique subaccounts
        const subaccountMap = new Map();
        allLeadsData.forEach(l => {
          if (l.ghl_connections) {
            subaccountMap.set(l.ghl_connections.location_id, l.ghl_connections.location_name);
          }
        });
        allSubaccounts = Array.from(subaccountMap, ([id, name]) => ({ id, name }));

        updateSubaccountFilter();
        updateAnalyseStats();
        renderLeadsTable();
      } catch (error) {
        console.error('Error loading leads:', error);
        document.getElementById('leadsAnalyseTable').innerHTML =
          `<tr><td colspan="7" class="empty-state">Fehler: ${error.message}</td></tr>`;
      }
    }

    function getFilteredLeads() {
      // First filter by archived status
      let filtered = showArchivedFilter ? allLeadsData : allLeadsData.filter(l => !l.is_archived);
      return filtered;
    }

    function updateSubaccountFilter() {
      const select = document.getElementById('subaccountFilter');
      if (!select) return;

      const filteredLeads = getFilteredLeads();

      // Update options
      select.innerHTML = `<option value="alle">Alle Makler (${filteredLeads.length})</option>` +
        allSubaccounts.map(s => {
          const count = filteredLeads.filter(l => l.ghl_connections?.location_id === s.id).length;
          return `<option value="${s.id}">${s.name} (${count})</option>`;
        }).join('');

      // Restore selection
      select.value = currentSubaccountFilter;
    }

    function filterBySubaccount(value) {
      currentSubaccountFilter = value;
      renderLeadsTable();
    }

    function toggleArchived() {
      showArchivedFilter = document.getElementById('showArchived').checked;
      updateSubaccountFilter();
      updateAnalyseStats();
      renderLeadsTable();
    }

    function updateAnalyseStats() {
      const filteredLeads = getFilteredLeads();
      const total = filteredLeads.length;
      const withScore = filteredLeads.filter(l => l.ai_quality_score !== null);
      const avgQuality = withScore.length > 0
        ? (withScore.reduce((sum, l) => sum + l.ai_quality_score, 0) / withScore.length).toFixed(1)
        : '-';

      const needsAttention = filteredLeads.filter(l =>
        l.conversation_status === 'unterhaltung_abgebrochen' ||
        (l.ai_quality_score !== null && l.ai_quality_score < 5)
      ).length;

      const notAnalyzed = filteredLeads.filter(l =>
        l.last_analyzed_at === null ||
        (l.last_message_at && new Date(l.last_message_at) > new Date(l.last_analyzed_at))
      ).length;

      // Count archived leads
      const archivedCount = allLeadsData.filter(l => l.is_archived).length;
      if (archivedCount > 0 && !showArchivedFilter) {
        document.getElementById('analyseTotal').textContent = `${total} (+${archivedCount} archiviert)`;
      } else {
        document.getElementById('analyseTotal').textContent = total;
      }

      document.getElementById('analyseQuality').textContent = avgQuality;
      document.getElementById('analyseAttention').textContent = needsAttention;
      document.getElementById('analyseNotAnalyzed').textContent = notAnalyzed;
    }

    function filterLeads(filter) {
      currentFilter = filter;

      // Update filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      renderLeadsTable();
    }

    function renderLeadsTable() {
      // Start with archived-filtered leads
      let filteredLeads = getFilteredLeads();

      // Apply subaccount filter
      if (currentSubaccountFilter !== 'alle') {
        filteredLeads = filteredLeads.filter(l =>
          l.ghl_connections?.location_id === currentSubaccountFilter
        );
      }

      // Apply status filter
      if (currentFilter === 'attention') {
        filteredLeads = filteredLeads.filter(l =>
          l.conversation_status === 'unterhaltung_abgebrochen' ||
          (l.ai_quality_score !== null && l.ai_quality_score < 5)
        );
      } else if (currentFilter !== 'alle') {
        filteredLeads = filteredLeads.filter(l => l.conversation_status === currentFilter);
      }

      const tbody = document.getElementById('leadsAnalyseTable');

      if (filteredLeads.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Keine Leads gefunden</td></tr>';
        return;
      }

      tbody.innerHTML = filteredLeads.map(lead => {
        const status = lead.conversation_status || 'unterhaltung_laeuft';
        const score = lead.ai_quality_score;
        const scoreClass = score === null ? 'score-none' :
          score >= 7 ? 'score-high' : score >= 4 ? 'score-medium' : 'score-low';

        const hasNewMessages = lead.last_message_at &&
          (!lead.last_analyzed_at || new Date(lead.last_message_at) > new Date(lead.last_analyzed_at));

        const isArchived = lead.is_archived;

        return `
          <tr onclick="openConversation('${lead.id}')" class="${isArchived ? 'archived-row' : ''}">
            <td>
              <strong>${escapeHtml(lead.name || 'Unbekannt')}</strong>
              ${isArchived ? '<span class="archived-badge">ARCHIVIERT</span>' : ''}
              ${hasNewMessages && !isArchived ? '<span class="new-badge">NEU</span>' : ''}
              <br><small style="color: #6B7280;">${lead.email || lead.phone || '-'}</small>
            </td>
            <td>${lead.ghl_connections?.location_name || '-'}</td>
            <td><span class="status-badge status-${status}">${getStatusText(status)}</span></td>
            <td><span class="score-badge ${scoreClass}">${score !== null ? score : '-'}</span></td>
            <td class="suggestion-text">${escapeHtml(lead.ai_improvement_suggestion || '-')}</td>
            <td class="date-text">${formatDate(lead.last_message_at)}</td>
            <td class="date-text">${formatDate(lead.last_analyzed_at)}</td>
          </tr>
        `;
      }).join('');
    }

    function getStatusText(status) {
      const statusLabels = {
        'unterhaltung_laeuft': 'Läuft',
        'unterhaltung_abgebrochen': 'Abgebrochen',
        'termin_gebucht': 'Termin gebucht',
        'termin_angefragt': 'Termin angefragt',
        'simpli_interessiert': 'Simpli interessiert',
        'simpli_nicht_interessiert': 'Simpli nicht interessiert',
        'abgeschlossen': 'Abgeschlossen'
      };
      return statusLabels[status] || status;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;

      if (diff < 3600000) return 'Vor ' + Math.round(diff / 60000) + ' Min';
      if (diff < 86400000) return 'Vor ' + Math.round(diff / 3600000) + ' Std';
      if (diff < 604800000) return 'Vor ' + Math.round(diff / 86400000) + ' Tagen';

      return date.toLocaleDateString('de-DE');
    }

    async function refreshAnalysis(forceAll = false) {
      const btn = document.getElementById('refreshBtn');
      const btnAll = document.getElementById('refreshAllBtn');
      const statusEl = document.getElementById('analyseStatus');
      const progressModal = document.getElementById('analysisProgressModal');
      const progressBar = document.getElementById('analysisProgressBar');
      const progressText = document.getElementById('analysisProgressText');
      const progressPercent = document.getElementById('analysisProgressPercent');
      const progressDetails = document.getElementById('analysisProgressDetails');

      // Disable both buttons
      btn.disabled = true;
      btnAll.disabled = true;

      if (forceAll) {
        document.getElementById('refreshAllBtnText').innerHTML = '&#8987; Analysiere...';
      } else {
        document.getElementById('refreshBtnText').innerHTML = '&#8987; Analysiere...';
      }

      // Count leads to analyze
      let leadsToAnalyze;
      if (forceAll) {
        leadsToAnalyze = getFilteredLeads(); // All non-archived leads
      } else {
        leadsToAnalyze = getFilteredLeads().filter(l =>
          l.last_analyzed_at === null ||
          (l.last_message_at && new Date(l.last_message_at) > new Date(l.last_analyzed_at))
        );
      }

      const totalLeads = leadsToAnalyze.length;

      if (totalLeads === 0) {
        statusEl.textContent = forceAll ? '✅ Keine Leads zum Analysieren' : '✅ Alle Leads sind aktuell';
        btn.disabled = false;
        btnAll.disabled = false;
        document.getElementById('refreshBtnText').innerHTML = '&#8635; Neue analysieren';
        document.getElementById('refreshAllBtnText').innerHTML = '&#128260; Alle neu analysieren';
        setTimeout(() => { statusEl.textContent = ''; }, 3000);
        return;
      }

      // Show progress modal
      progressModal.classList.add('open');
      progressBar.style.width = '0%';
      progressText.textContent = `0 von ${totalLeads} Leads`;
      progressPercent.textContent = '0%';
      progressDetails.textContent = forceAll ? 'Analysiere alle Leads neu...' : 'Analysiere neue Nachrichten...';

      // Animate progress while waiting (fake progress up to 95%)
      let currentProgress = 0;
      const progressInterval = setInterval(() => {
        if (currentProgress < 95) {
          // Slow down as we approach 95%
          const increment = currentProgress < 50 ? 2 : (currentProgress < 80 ? 1 : 0.3);
          currentProgress = Math.min(95, currentProgress + increment);

          const estimatedDone = Math.floor((currentProgress / 100) * totalLeads);
          progressBar.style.width = currentProgress + '%';
          progressText.textContent = `~${estimatedDone} von ${totalLeads} Leads`;
          progressPercent.textContent = Math.floor(currentProgress) + '%';
        }
      }, 200);

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        const prompts = getAnalysePrompts();

        const response = await fetch(`${SUPABASE_URL}/functions/v1/sync-analyze-leads`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            force_all: forceAll,
            prompts: prompts
          })
        });

        clearInterval(progressInterval);
        const result = await response.json();

        if (result.success) {
          // Jump to 100%
          progressBar.style.width = '100%';
          progressText.textContent = `${result.analyzed} von ${totalLeads} Leads`;
          progressPercent.textContent = '100%';
          progressDetails.textContent = '✅ Analyse abgeschlossen!';

          statusEl.textContent = `✅ ${result.analyzed} Leads analysiert`;

          // Close modal after 1.5s
          setTimeout(async () => {
            progressModal.classList.remove('open');
            await loadLeadsAnalyse();
            await loadStats();
          }, 1500);

          setTimeout(() => { statusEl.textContent = ''; }, 5000);
        } else {
          clearInterval(progressInterval);
          progressModal.classList.remove('open');
          statusEl.textContent = '❌ ' + result.error;
        }
      } catch (error) {
        clearInterval(progressInterval);
        progressModal.classList.remove('open');
        statusEl.textContent = '❌ Fehler: ' + error.message;
      }

      btn.disabled = false;
      btnAll.disabled = false;
      document.getElementById('refreshBtnText').innerHTML = '&#8635; Neue analysieren';
      document.getElementById('refreshAllBtnText').innerHTML = '&#128260; Alle neu analysieren';
    }

    function exportLeadsCSV() {
      if (allLeadsData.length === 0) {
        alert('Keine Daten zum Exportieren');
        return;
      }

      const headers = ['Lead', 'Email', 'Telefon', 'Makler', 'Status', 'KI-Score', 'Verbesserung', 'Letzte Nachricht', 'Analysiert'];
      const rows = allLeadsData.map(l => [
        l.name || 'Unbekannt',
        l.email || '',
        l.phone || '',
        l.ghl_connections?.location_name || '',
        getStatusText(l.conversation_status || 'unterhaltung_laeuft'),
        l.ai_quality_score !== null ? l.ai_quality_score : '',
        `"${(l.ai_improvement_suggestion || '').replace(/"/g, '""')}"`,
        l.last_message_at ? new Date(l.last_message_at).toLocaleString('de-DE') : '',
        l.last_analyzed_at ? new Date(l.last_analyzed_at).toLocaleString('de-DE') : ''
      ]);

      const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `leads_analyse_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();

      URL.revokeObjectURL(url);
    }

    // Update loadData to include leads analyse
    const originalLoadData = loadData;
    loadData = async function() {
      await originalLoadData();
      await loadLeadsAnalyse();
    };

    // ========== CONVERSATION MODAL ==========
    async function openConversation(leadId) {
      const lead = allLeadsData.find(l => l.id === leadId);
      if (!lead) return;

      // Show modal
      document.getElementById('conversationModal').classList.add('open');

      // Set header info
      document.getElementById('conversationLeadName').textContent = lead.name || 'Unbekannt';
      document.getElementById('conversationLeadMeta').textContent =
        [lead.email, lead.phone, lead.ghl_connections?.location_name].filter(Boolean).join(' • ');

      // Set analysis info
      const status = lead.conversation_status || 'unterhaltung_laeuft';
      const statusEl = document.getElementById('convStatus');
      statusEl.textContent = getStatusText(status);
      statusEl.className = 'status-badge status-' + status;

      const score = lead.ai_quality_score;
      const scoreEl = document.getElementById('convScore');
      scoreEl.textContent = score !== null ? score : '-';
      scoreEl.className = 'score-badge ' + (score === null ? 'score-none' :
        score >= 7 ? 'score-high' : score >= 4 ? 'score-medium' : 'score-low');

      document.getElementById('convSuggestion').textContent = lead.ai_improvement_suggestion || '-';

      // Load messages
      const messagesDiv = document.getElementById('conversationMessages');
      messagesDiv.innerHTML = '<div class="loading">Lade Nachrichten...</div>';

      try {
        const { data: messages, error } = await supabaseClient
          .from('messages')
          .select('id, content, type, created_at')
          .eq('lead_id', leadId)
          .order('created_at', { ascending: true });

        if (error) throw error;

        if (!messages || messages.length === 0) {
          messagesDiv.innerHTML = '<div class="empty">Keine Nachrichten vorhanden</div>';
          return;
        }

        messagesDiv.innerHTML = messages.map(msg => `
          <div class="conv-message ${msg.type === 'incoming' ? 'incoming' : 'outgoing'}">
            ${escapeHtml(msg.content)}
            <div class="conv-message-time">${new Date(msg.created_at).toLocaleString('de-DE')}</div>
          </div>
        `).join('');

        // Scroll to bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } catch (error) {
        messagesDiv.innerHTML = `<div class="empty">Fehler: ${error.message}</div>`;
      }
    }

    function closeConversation() {
      document.getElementById('conversationModal').classList.remove('open');
    }

    // Close modal on backdrop click
    document.getElementById('conversationModal').addEventListener('click', (e) => {
      if (e.target.id === 'conversationModal') {
        closeConversation();
      }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeConversation();
        closeAnalyseSettings();
      }
    });

    // ========== ANALYSE SETTINGS ==========
    const SETTINGS_KEY = 'simpli_analyse_prompts';

    function loadAnalyseSettings() {
      const saved = localStorage.getItem(SETTINGS_KEY);
      if (saved) {
        try {
          const settings = JSON.parse(saved);
          if (settings.promptStatus) document.getElementById('promptStatus').value = settings.promptStatus;
          if (settings.promptScore) document.getElementById('promptScore').value = settings.promptScore;
          if (settings.promptImprovement) document.getElementById('promptImprovement').value = settings.promptImprovement;
        } catch (e) {
          console.error('Failed to load settings:', e);
        }
      }
    }

    function openAnalyseSettings() {
      loadAnalyseSettings();
      document.getElementById('analyseSettingsModal').classList.add('open');
    }

    function closeAnalyseSettings() {
      document.getElementById('analyseSettingsModal').classList.remove('open');
    }

    function saveAnalyseSettings() {
      const settings = {
        promptStatus: document.getElementById('promptStatus').value,
        promptScore: document.getElementById('promptScore').value,
        promptImprovement: document.getElementById('promptImprovement').value
      };
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      closeAnalyseSettings();
      alert('Prompts gespeichert! Die neuen Prompts werden bei der nächsten Analyse verwendet.');
    }

    function getAnalysePrompts() {
      const saved = localStorage.getItem(SETTINGS_KEY);
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {}
      }
      return {
        promptStatus: document.getElementById('promptStatus')?.value || '',
        promptScore: document.getElementById('promptScore')?.value || '',
        promptImprovement: document.getElementById('promptImprovement')?.value || ''
      };
    }

    // Close settings modal on backdrop click
    document.getElementById('analyseSettingsModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'analyseSettingsModal') {
        closeAnalyseSettings();
      }
    });

    // Init
    checkAuth();
  </script>
</body>
</html>
